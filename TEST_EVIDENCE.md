# Test Evidence and Coverage Documentation

This document provides an overview of the testing strategy, coverage metrics, and quality gates implemented in CA_Scanner.

## Table of Contents
1. [Testing Strategy](#testing-strategy)
2. [Test Coverage Metrics](#test-coverage-metrics)
3. [Quality Gates](#quality-gates)
4. [Integration Testing](#integration-testing)
5. [Mutation Testing](#mutation-testing)
6. [Performance Regression Testing](#performance-regression-testing)

## Testing Strategy

CA_Scanner employs a comprehensive testing strategy that includes:

1. **Unit Tests**: Covering individual methods and classes
2. **Integration Tests**: Testing interactions between components
3. **End-to-End Tests**: Validating complete workflows
4. **Performance Tests**: Ensuring non-regression of performance
5. **Mutation Tests**: Verifying test quality by introducing mutations

## Test Coverage Metrics

The project maintains the following coverage targets:

- Line coverage: 85%+
- Branch coverage: 70%+

These metrics are enforced in the CI/CD pipeline and reported via GitHub Pages.

## Quality Gates

Quality gates have been implemented to ensure code quality:

1. **Minimum Coverage Thresholds**: Enforced at 85% line and 70% branch coverage
2. **Mutation Testing Score**: Minimum mutation score of 80%
3. **Performance Regression Detection**: Automated performance regression tests
4. **Static Code Analysis**: Integrated with SonarAnalyzer, StyleCop, and FxCop

## Integration Testing

Integration testing has been enhanced to include:

1. **Microsoft Graph API Mocking**: Using Moq for reliable integration tests
2. **Cross-Format Policy Comparison**: Testing JSON vs Terraform conversions
3. **Large Dataset Processing**: Validating performance with large policy sets

## Mutation Testing

Mutation testing is implemented using Stryker.NET, which introduces small changes to the codebase and verifies that tests fail when they should.

Configuration:
```json
{
  "mutate": [
    "**/ConditionalAccessExporter/*.cs",
    "**/ConditionalAccessExporter/Services/*.cs"
  ],
  "testProject": "ConditionalAccessExporter.Tests/ConditionalAccessExporter.Tests.csproj",
  "reportType": ["html", "clearText"],
  "thresholds": {
    "high": {
      "mutants": 80,
      "survivedMutants": 5
    },
    "low": {
      "mutants": 60,
      "survivedMutants": 10
    }
  },
  "concurrency": 4,
  "dryRun": false,
  "logLevel": "info",
  "maxConcurrentTests": 8,
  "parallelizeTestsByClass": true,
  "reporters": ["clearText", "html"],
  "coverageAnalysis": "PerTest"
}
```

## Performance Regression Testing

Performance regression tests have been implemented to ensure that:

1. Policy comparisons complete in under 50ms
2. Large dataset processing (1000 policies) completes in under 30 seconds
3. Cross-format policy comparison completes in under 5 seconds
4. Memory usage does not leak excessively during operations

These tests are part of the CI/CD pipeline and will fail if performance regressions are detected.

## Test Data Management

A test data factory has been implemented to provide consistent, reusable test data across all tests:

```csharp
public static class TestDataFactory
{
    public static JObject CreateBasicJsonPolicy(string id = "test-policy-id", string displayName = "Test Policy", string state = "enabled") { /*...*/ }
    public static string CreateBasicTerraformPolicy(string resourceName = "test_policy", string displayName = "Test Policy", string state = "enabled") { /*...*/ }
    // Additional methods for creating complex policies, large datasets, etc.
}
```

## Test Result Reporting

Test results are reported in multiple formats:

1. **Console Output**: Detailed test output during local execution
2. **HTML Reports**: Generated by ReportGenerator and published to GitHub Pages
3. **Mutation Testing Reports**: Available as HTML and clear text
4. **Performance Metrics**: Included in test output and reports

## Test Execution

Tests are executed automatically via GitHub Actions on every push to main and pull request:

```yaml
name: .NET Tests and Coverage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Workflow steps include...
- name: Test with coverage
- name: Generate code coverage report
- name: Enforce minimum coverage threshold
- name: Run mutation testing
```

## Conclusion

The enhanced testing framework ensures high code quality, reliable performance, and maintainability of the CA_Scanner project.
